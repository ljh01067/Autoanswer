<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #FFF3CD;
    }

    .information {
      border: 1px solid #ccc;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      background-color: #F2F2EB;
      height: 100px;
      width: 200px;
    }
    .ShowInformation {
      border: 1px solid #ccc;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      background-color: #F2F2EB;
      height: 100px;
      width: 200px;
    }

    button {
      border-radius: 10px;
      background: none; /* ë²„íŠ¼ ë°°ê²½ ì œê±° */
      border: none; /* ë²„íŠ¼ í…Œë‘ë¦¬ ì œê±° */
      cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° */
      padding: 5px 10px; /* ì—¬ë°± ì„¤ì • */
    }

    button:hover {
      border: 1px solid #ccc;
      background-color: #FFF3CD;
    }
  </style>
</head>
<body>
<select id="areaSelect" onchange="updateSigunguOptions()">
  <option value="">ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
  <!-- ì§€ì—­ ëª©ë¡ì´ ì—¬ê¸° ë“¤ì–´ê°‘ë‹ˆë‹¤. -->
</select>

<select id="sigunguSelect">
  <option value="">ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
  <!-- ì‹œêµ°êµ¬ ëª©ë¡ì€ ì²« ë²ˆì§¸ ì„ íƒì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
</select>
<button onclick="searchLocation()">ì°¿ê¸°</button>
<div class="information"></div>
<div class="ShowInformation"></div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const areaSelect = document.getElementById("areaSelect");

    // AJAXë¡œ ì§€ì—­ ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤
    fetch('/getAreaList')
            .then(response => response.json())
            .then(data => {
              console.log("data : ", data);
              data.forEach(item => {
                const option = document.createElement("option");
                option.value = item.areaNm;  // ì§€ì—­ ì´ë¦„ì„ valueë¡œ ì„¤ì •
                option.textContent = item.areaNm;  // ì§€ì—­ ì´ë¦„ì„ í…ìŠ¤íŠ¸ë¡œ ì„¤ì •
                areaSelect.appendChild(option);
              });
            })
            .catch(error => {
              console.error("ì§€ì—­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
            });
  });
  function updateSigunguOptions() {
    const areaSelect = document.getElementById("areaSelect");
    const sigunguSelect = document.getElementById("sigunguSelect");

    // ì´ì „ì— ì±„ìš´ ì‹œêµ°êµ¬ ì˜µì…˜ì„ ì§€ìš´ë‹¤
    sigunguSelect.innerHTML = '<option value="">ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>';

    const areaName = areaSelect.value;

    if (areaName) {
      // AJAXë¡œ ì‹œêµ°êµ¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
      fetch(`/getSigunguList?areaNm=${areaName}`)
              .then(response => response.json())
              .then(data => {
                data.forEach(item => {
                  const option = document.createElement("option");
                  option.value = item.sigunguNm;
                  option.textContent = item.sigunguNm;
                  sigunguSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error("ì‹œêµ°êµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
              });
    }
  }

  function searchLocation() {
    const areaSelect = document.getElementById("areaSelect");
    const sigunguSelect = document.getElementById("sigunguSelect");

    // ì„ íƒëœ ì§€ì—­ ì´ë¦„ê³¼ ì‹œêµ°êµ¬ ì´ë¦„ì„ ê°€ì ¸ì˜´
    const areaName = areaSelect.value;
    const sigunguName = sigunguSelect.value;

    // ë‘ ê°’ì´ ëª¨ë‘ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!areaName) {
      alert("ì§€ì—­ê³¼ ì‹œêµ°êµ¬ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    fetch(`/getCode?areaNm=${encodeURIComponent(areaName)}&sigunguNm=${encodeURIComponent(sigunguName)}`)
            .then(response => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json(); // JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ ë°›ê¸°
            })
            .then(data => {
              console.log(data);
              const areacd = data[0].areaCd;
              const sigungucd = data[0].signguCd;
              fetch(`/usr/walk/getShow?areaCd=${areacd}&signguCd=${sigungucd}`)
                      .then(response => {
                        if (!response.ok) {
                          throw new Error("Network response was not ok");
                        }
                        return response.json(); // JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ ë°›ê¸°
                      })
                      .then(data => {
                        console.log(data);
                      }).catch(error => {
                console.error("There was a problem with the fetch operation:", error);
                alert("ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³ 
              });
            })
            .catch(error => {
              console.error("There was a problem with the fetch operation:", error);
              alert("ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³ 
            });


    // ì„ íƒëœ ê°’ì„ ê²°í•©í•˜ì—¬ location ë³€ìˆ˜ì— ì €ì¥
    const location = areaName;

    // ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ëƒ„
    fetch(`/getLatLng?location=${location}`)
            .then(response => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json(); // JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ ë°›ê¸°
            })
            .then(data => {
              console.log(data);
              // ë°˜í™˜ëœ ìœ„ë„ì™€ ê²½ë„ ì²˜ë¦¬
              if (data) {
                const lat = data[0];
                const lng = data[1];
                const gridCoordinates = convertLatLngToGrid(lat, lng);
                getWeatherInfo(gridCoordinates.nx, gridCoordinates.ny);
              } else {
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì„ ê²½ìš° ê²½ê³ 
              }
            })
            .catch(error => {
              console.error("There was a problem with the fetch operation:", error);
              alert("ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³ 
            });
  }
  let polyline; // Polyline ê°ì²´ ì¶”ê°€
  let path = []; // ê²½ë¡œë¥¼ ì €ì¥í•  ë°°ì—´
  var RE = 6371.00877; // ì§€êµ¬ ë°˜ê²½(km)
  var GRID = 5.0; // ê²©ì ê°„ê²©(km)
  var SLAT1 = 30.0; // íˆ¬ì˜ ìœ„ë„1(degree)
  var SLAT2 = 60.0; // íˆ¬ì˜ ìœ„ë„2(degree)
  var OLON = 126.0; // ê¸°ì¤€ì  ê²½ë„(degree)
  var OLAT = 38.0; // ê¸°ì¤€ì  ìœ„ë„(degree)
  var XO = 43; // ê¸°ì¤€ì  Xì¢Œí‘œ(GRID)
  var YO = 136; // ê¸°ì¤€ì  Yì¢Œí‘œ(GRID)
  function dfs_xy_conv(code, v1, v2) {
    var DEGRAD = Math.PI / 180.0;
    var RADDEG = 180.0 / Math.PI;

    var re = RE / GRID;
    var slat1 = SLAT1 * DEGRAD;
    var slat2 = SLAT2 * DEGRAD;
    var olon = OLON * DEGRAD;
    var olat = OLAT * DEGRAD;

    var sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
    sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
    var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
    sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
    var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
    ro = re * sf / Math.pow(ro, sn);

    var rs = {};
    if (code == "toXY") {
      rs['lat'] = v1; // ìœ„ë„
      rs['lng'] = v2; // ê²½ë„
      var ra = Math.tan(Math.PI * 0.25 + (v1) * DEGRAD * 0.5);
      ra = re * sf / Math.pow(ra, sn);
      var theta = v2 * DEGRAD - olon;
      if (theta > Math.PI) theta -= 2.0 * Math.PI;
      if (theta < -Math.PI) theta += 2.0 * Math.PI;
      theta *= sn;
      rs['x'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
      rs['y'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
    } else {
      rs['x'] = v1; // Xì¢Œí‘œ
      rs['y'] = v2; // Yì¢Œí‘œ
      var xn = v1 - XO;
      var yn = ro - v2 + YO;
      ra = Math.sqrt(xn * xn + yn * yn);
      if (sn < 0.0) ra = -ra;
      var alat = Math.pow((re * sf / ra), (1.0 / sn));
      alat = 2.0 * Math.atan(alat) - Math.PI * 0.5;

      if (Math.abs(xn) <= 0.0) {
        theta = 0.0;
      } else {
        if (Math.abs(yn) <= 0.0) {
          theta = Math.PI * 0.5;
          if (xn < 0.0) theta = -theta;
        } else {
          theta = Math.atan2(xn, yn);
        }
      }
      var alon = theta / sn + olon;
      rs['lat'] = alat * RADDEG; // ë³€í™˜ëœ ìœ„ë„
      rs['lng'] = alon * RADDEG; // ë³€í™˜ëœ ê²½ë„
    }
    return rs; // ê²°ê³¼ ë°˜í™˜
  }

  // ìœ„ê²½ë„ë¥¼ ê²©ì ì¢Œí‘œë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function convertLatLngToGrid(latitude, longitude) {
    var result = dfs_xy_conv("toXY", latitude, longitude);
    return {
      nx: String(result.x), // nxë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
      ny: String(result.y)  // nyë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
    };
  }
  function getCurrentDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
    const day = String(today.getDate()).padStart(2, '0');

    return `${year}${month}${day}`;
  }
  function getCurrentHour() {
    const today = new Date();
    const hours = today.getHours(); // í˜„ì¬ ì‹œê°„ (0-23)
    const minutes = today.getMinutes(); // í˜„ì¬ ë¶„ (0-59)

    // í˜„ì¬ ì‹œê°„ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let adjustedHour;

    // ë¶„ì´ 10ë¶„ ë¯¸ë§Œì´ë©´ ì „ì‹œê°„ìœ¼ë¡œ ì„¤ì •
    if (minutes < 10) {
      adjustedHour = hours > 0 ? hours - 1 : 23; // 0ì‹œì¸ ê²½ìš° 23ì‹œë¡œ ì„¤ì •
    } else {
      adjustedHour = hours; // 10ë¶„ ì´ìƒì´ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
    }

    // 2ìë¦¬ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
    return String(adjustedHour).padStart(2, '0') + "00"; // ì˜ˆ: "0700", "0800"
  }

  function getWeatherInfo(nx, ny) {
    // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const date = getCurrentDate();
    const hour = getCurrentHour();
    console.log(date);
    console.log(hour);
    console.log(nx);
    console.log(ny);

    // AJAX ìš”ì²­ì„ í†µí•´ ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch(`/usr/walk/getWeather?date=${date}&hour=${hour}&nx=${nx}&ny=${ny}`)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
              }
              return response.json(); // JSON í˜•íƒœë¡œ ì‘ë‹µì„ ê°€ì ¸ì˜¤ê¸°
            })
            .then(data => {
              console.log(data);
              // obsrValue ê°’ì„ ì €ì¥í•  ë³€ìˆ˜
              let obsrValuePTY, obsrValueRN1, obsrValueT1H;

              // items.item ë°°ì—´ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆœíšŒ
              const items = data.response.body.items.item; // item ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
              if (Array.isArray(items)) {
                items.forEach(item => {
                  const category = item.category; // category ê°’ì„ ê°€ì ¸ì˜´
                  const obsrValue = item.obsrValue; // obsrValue ê°’ì„ ê°€ì ¸ì˜´

                  // categoryì— ë”°ë¼ obsrValue ê°’ í• ë‹¹
                  if (category === "PTY") {
                    obsrValuePTY = obsrValue;
                  } else if (category === "RN1") {
                    obsrValueRN1 = obsrValue;
                  } else if (category === "T1H") {
                    obsrValueT1H = obsrValue;
                  }
                });
              }

              // obsrValuePTYì— ë”°ë¼ ì•„ì´ì½˜ ê²°ì •
              const weatherIcon = {
                "0": "ğŸŒ",  // ë§‘ìŒ
                "1": "ğŸŒ§",  // ë¹„
                "2": "ğŸŒ§/ğŸŒ¨", // ë¹„/ëˆˆ
                "3": "ğŸŒ¨",  // ëˆˆ
                "4": "â›ˆ",  // ì²œë‘¥ë²ˆê°œ
              };

              // PTYì— ë”°ë¥¸ ë‚ ì”¨ ì•„ì´ì½˜ ì¶œë ¥
              const weatherSymbol = weatherIcon[obsrValuePTY] || "â“"; // ê¸°ë³¸ ì•„ì´ì½˜
              const weatherSymbolElement = document.querySelector(".information"); // ë‚ ì”¨ ì•„ì´ì½˜ì„ í‘œì‹œí•  ìš”ì†Œ

              // "ì´ ì§€ì—­ì˜ ë‚ ì”¨" ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  ì•„ì´ì½˜ì„ ë‹¤ìŒ ì¤„ì— í‘œì‹œ
              weatherSymbolElement.innerHTML = `ì´ ì§€ì—­ì˜ ë‚ ì”¨<br><span style="font-size: 1.5em;">${weatherSymbol}</span`; // í¬ê¸° ì¡°ì • ë° ì¤„ ë°”ê¿ˆ ì¶”ê°€

              // ê¸°ì˜¨ ì²˜ë¦¬ ë° í‘œì‹œ
              if (obsrValueT1H) {
                const temperature = `${obsrValueT1H}Â°C`; // ì„­ì”¨ ê¸°í˜¸ ë¶™ì´ê¸°
                const temperatureElement = document.createElement('div');
                temperatureElement.textContent = `ê¸°ì˜¨: ${temperature}`;
                weatherSymbolElement.appendChild(temperatureElement); // ë‚ ì”¨ ì•„ì´ì½˜ ì•„ë˜ì— ì¶”ê°€
              }

              // ê°•ìˆ˜ëŸ‰ ì²˜ë¦¬ ë° í‘œì‹œ
              if (obsrValueRN1 > 0) { // ê°•ìˆ˜ëŸ‰ì´ 0 ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ
                const rainfall = `${obsrValueRN1}mm`; // ê°•ìˆ˜ëŸ‰ì— .mm ë¶™ì´ê¸°
                const rainfallElement = document.createElement('div');
                rainfallElement.textContent = `ê°•ìˆ˜ëŸ‰: ${rainfall}`;
                weatherSymbolElement.appendChild(rainfallElement); // ë‚ ì”¨ ì•„ì´ì½˜ ì•„ë˜ì— ì¶”ê°€
              }

            })
            .catch(error => {
              console.error('Error fetching weather data:', error);
            });
  }
</script>
</body>
</html>
